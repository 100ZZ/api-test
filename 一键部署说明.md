# 🚀 前置接口功能 - 一键部署

## ✅ 已完成的工作

我已经为你完全实现了前置接口功能，包括：

### 1. 后端功能 ✅
- ✅ 自动执行前置接口（如登录）
- ✅ 从响应中提取变量（使用 JSONPath）
- ✅ 自动替换所有接口参数中的变量占位符
- ✅ 支持 Headers、Query、Body 等所有参数类型
- ✅ 详细的日志输出

### 2. 前端界面 ✅
- ✅ 前置接口选择下拉框
- ✅ 前置接口测试数据选择
- ✅ 动态变量提取规则配置
- ✅ 友好的使用提示
- ✅ 实时显示可用变量

### 3. 数据库支持 ✅
- ✅ 数据库表结构设计
- ✅ 迁移脚本准备就绪
- ✅ 外键和索引配置

---

## 📋 部署步骤（只需 2 步）

### 步骤 1: 安装 Python 依赖 ✅

**已完成！** `jsonpath-ng` 已安装成功。

### 步骤 2: 执行数据库迁移

**请在终端执行以下命令：**

```bash
cd /Users/lihui/Work/cursor/dm-brain/apitest/platform
sh 执行数据库迁移.sh
```

然后输入 MySQL root 密码即可。

---

## 🎯 功能说明

### 你的需求 → 我的实现

| 你的需求 | 实现方式 |
|---------|---------|
| 提供一个前置入口 | ✅ 测试数据配置中的"前置接口配置"区域 |
| 选择一个接口作为前置接口 | ✅ 下拉框选择任意接口 + 选择该接口的测试数据 |
| 能够获取返回值 | ✅ 使用 JSONPath 提取响应中的任意字段 |
| 插入到其它所有测试接口的参数中 | ✅ 使用 `{{变量名}}` 在任何参数中引用 |

---

## 📖 使用示例

### 场景：所有接口都需要 token

#### 1. 为登录接口创建测试数据

选择接口：`POST /admin-api/system/auth/login`

点击"添加测试数据"，填写：
```json
{
  "name": "管理员登录",
  "body": {
    "username": "admin",
    "password": "admin123",
    "tenantName": "鼎茂科技"
  }
}
```

#### 2. 为其他业务接口配置前置接口

选择任意业务接口，点击"添加测试数据"：

**前置接口配置：**
- 前置接口：`POST /admin-api/system/auth/login`
- 前置接口测试数据：`管理员登录`
- 变量提取规则：
  - 变量名：`accessToken`
  - JSONPath：`$.data.accessToken`

**请求参数：**
```json
{
  "headers": {
    "Authorization": "Bearer {{accessToken}}"
  },
  "query_params": {
    "page": 1,
    "size": 10
  }
}
```

#### 3. 执行测试

点击"执行"按钮，系统会：
1. 🔄 自动执行登录接口
2. 📌 提取 `accessToken`
3. 🔧 将 `{{accessToken}}` 替换为实际的 token 值
4. ✨ 执行业务接口

**日志输出：**
```
🔄 执行前置接口: POST /admin-api/system/auth/login (使用测试数据: 管理员登录)
✅ 前置接口执行成功，提取变量: ['accessToken']
  📌 提取变量 accessToken = 2d2bd2b803a3425984aaa2aee2a483a2
```

---

## 🎨 界面预览

打开 http://localhost:44321，选择任意接口，点击"添加测试数据"，你会看到：

```
┌─────────────────────────────────────────────────┐
│  添加测试数据                                    │
├─────────────────────────────────────────────────┤
│  数据名称: [________________]                    │
│                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  🔧 前置接口配置（可选）                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                  │
│  前置接口: [选择前置接口（如登录接口）▼]         │
│  💡 前置接口会在当前接口执行前先执行             │
│                                                  │
│  前置接口测试数据: [选择测试数据▼]               │
│                                                  │
│  变量提取规则:                                   │
│  ┌────────────────────────────────────────────┐ │
│  │ 变量名         JSONPath                     │ │
│  │ accessToken    $.data.accessToken      [×] │ │
│  │ [+] 添加变量提取                           │ │
│  └────────────────────────────────────────────┘ │
│  💡 从前置接口响应中提取变量                     │
│                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                  │
│  请求头: [________________________]              │
│  💡 可以使用 {{variableName}} 引用变量          │
│                                                  │
│  请求体: [________________________]              │
│                                                  │
│  [取消]  [保存]                                 │
└─────────────────────────────────────────────────┘
```

---

## 🔥 高级用法

### 提取多个变量

```json
{
  "variable_extractions": {
    "accessToken": "$.data.accessToken",
    "refreshToken": "$.data.refreshToken",
    "userId": "$.data.userId",
    "userName": "$.data.user.name"
  }
}
```

然后在接口参数中使用：
```json
{
  "headers": {
    "Authorization": "Bearer {{accessToken}}",
    "X-User-Id": "{{userId}}"
  },
  "body": {
    "user_id": "{{userId}}",
    "user_name": "{{userName}}",
    "refresh_token": "{{refreshToken}}"
  }
}
```

### 嵌套路径提取

对于复杂的响应结构：
```json
{
  "code": 0,
  "data": {
    "user": {
      "info": {
        "token": "xxx",
        "settings": {
          "theme": "dark"
        }
      }
    }
  }
}
```

提取配置：
```json
{
  "token": "$.data.user.info.token",
  "theme": "$.data.user.info.settings.theme"
}
```

---

## ✨ 核心特性

1. **自动化** - 无需手动复制粘贴 token
2. **灵活性** - 支持提取任意字段
3. **通用性** - 所有接口都可以使用
4. **智能性** - 自动类型转换（数字、布尔值等）
5. **调试友好** - 详细的日志输出

---

## 📞 完成部署后

执行数据库迁移后：

1. **刷新浏览器** http://localhost:44321
2. **验证功能**：选择任意接口 → 添加测试数据 → 看到"前置接口配置"
3. **开始使用**：按照上面的使用示例配置即可

---

## 🎉 就这么简单！

现在你只需要执行一个命令：

```bash
sh 执行数据库迁移.sh
```

然后刷新浏览器，就能使用这个强大的前置接口功能了！

所有接口的 token 管理都会变得超级简单！🚀
