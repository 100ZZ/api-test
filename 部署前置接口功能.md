# 前置接口功能部署指南

## 🔧 修复完成

已修复的问题：
1. ✅ Vue 模板编译错误（双花括号显示问题）
2. ✅ 后端逻辑完善
3. ✅ 前端 UI 完善

## 📋 部署步骤

### 步骤 1: 安装 Python 依赖

```bash
cd /Users/lihui/Work/cursor/dm-brain/apitest/platform/backend
pip install jsonpath-ng==1.6.1
```

### 步骤 2: 执行数据库迁移

**方法 1: 使用 SQL 文件（推荐）**

```bash
mysql -u root -p apitest < migrate_add_pre_request.sql
```

**方法 2: 手动执行 SQL**

连接到 MySQL 数据库：
```bash
mysql -u root -p apitest
```

然后执行以下 SQL：

```sql
-- 添加前置接口配置字段
ALTER TABLE test_data ADD COLUMN pre_request_api_id INTEGER;
ALTER TABLE test_data ADD COLUMN pre_request_test_data_id INTEGER;
ALTER TABLE test_data ADD COLUMN variable_extractions JSON;

-- 添加外键约束
ALTER TABLE test_data 
ADD CONSTRAINT fk_pre_request_api 
FOREIGN KEY (pre_request_api_id) 
REFERENCES apis(id) 
ON DELETE SET NULL;

ALTER TABLE test_data 
ADD CONSTRAINT fk_pre_request_test_data 
FOREIGN KEY (pre_request_test_data_id) 
REFERENCES test_data(id) 
ON DELETE SET NULL;

-- 添加索引
CREATE INDEX idx_test_data_pre_request_api_id ON test_data(pre_request_api_id);
CREATE INDEX idx_test_data_pre_request_test_data_id ON test_data(pre_request_test_data_id);
```

### 步骤 3: 重启服务

前端的修改会自动热更新，但为了确保后端生效，建议重启：

```bash
# 停止当前服务（按 Ctrl+C）
# 然后重新启动
sh start.sh
```

## ✅ 验证部署

### 1. 检查数据库表结构

```sql
DESC test_data;
```

应该看到新增的字段：
- `pre_request_api_id`
- `pre_request_test_data_id`
- `variable_extractions`

### 2. 检查前端页面

打开 http://localhost:44321，选择任意接口，点击"添加测试数据"，应该看到：
- 前置接口配置区域
- 变量提取规则配置
- 友好的提示信息

### 3. 测试完整流程

#### 3.1 创建登录接口测试数据

1. 选择登录接口：`POST /admin-api/system/auth/login`
2. 点击"添加测试数据"
3. 填写：
   - 数据名称：`管理员登录`
   - 请求体：
     ```json
     {
       "username": "admin",
       "password": "admin123",
       "tenantName": "鼎茂科技",
       "captchaVerification": "",
       "rememberMe": true
     }
     ```
4. 保存

#### 3.2 创建业务接口测试数据（使用前置接口）

1. 选择任意需要认证的业务接口
2. 点击"添加测试数据"
3. 展开"前置接口配置"：
   - **前置接口**：选择 `POST /admin-api/system/auth/login`
   - **前置接口测试数据**：选择 `管理员登录`
   - 点击"添加变量提取"：
     - 变量名：`accessToken`
     - JSONPath：`$.data.accessToken`
4. 在"请求头"中填写：
   ```json
   {
     "Authorization": "Bearer {{accessToken}}"
   }
   ```
5. 保存

#### 3.3 执行测试

1. 选择刚才创建的测试数据
2. 点击"执行"
3. 查看后端日志，应该看到：
   ```
   🔄 执行前置接口: POST /admin-api/system/auth/login (使用测试数据: 管理员登录)
   ✅ 前置接口执行成功，提取变量: ['accessToken']
     📌 提取变量 accessToken = xxx
   ```

## 🎯 功能特点

### 1. 自动登录
- 测试接口时自动先调用登录接口
- 无需手动复制粘贴 token

### 2. 变量提取
- 支持 JSONPath 语法
- 可提取响应中的任意字段
- 支持提取多个变量

### 3. 变量使用
- 在任何参数中使用 `{{变量名}}` 引用
- 支持 Headers、Query、Body 等所有参数
- 智能类型保持（数字、布尔值等）

### 4. 调试友好
- 详细的日志输出
- 清晰的错误提示
- 易于排查问题

## 📝 使用示例

### 示例 1: 基本认证

```json
{
  "name": "获取用户列表",
  "pre_request_api_id": 1,
  "pre_request_test_data_id": 10,
  "variable_extractions": {
    "accessToken": "$.data.accessToken"
  },
  "headers": {
    "Authorization": "Bearer {{accessToken}}",
    "Content-Type": "application/json"
  },
  "query_params": {
    "page": 1,
    "size": 10
  }
}
```

### 示例 2: 提取多个变量

```json
{
  "name": "更新用户信息",
  "pre_request_api_id": 1,
  "pre_request_test_data_id": 10,
  "variable_extractions": {
    "accessToken": "$.data.accessToken",
    "userId": "$.data.userId",
    "refreshToken": "$.data.refreshToken"
  },
  "headers": {
    "Authorization": "Bearer {{accessToken}}",
    "X-User-Id": "{{userId}}"
  },
  "body": {
    "user_id": "{{userId}}",
    "name": "新名称"
  }
}
```

### 示例 3: 嵌套路径提取

对于复杂的响应结构：
```json
{
  "code": 0,
  "data": {
    "user": {
      "profile": {
        "avatar": "https://example.com/avatar.jpg",
        "settings": {
          "theme": "dark"
        }
      }
    }
  }
}
```

变量提取配置：
```json
{
  "avatar": "$.data.user.profile.avatar",
  "theme": "$.data.user.profile.settings.theme"
}
```

## 🐛 常见问题

### Q1: 前端编译错误

**症状**：
```
Error parsing JavaScript expression: Unterminated string constant
```

**解决**：
已修复，确保使用 `<code v-pre>{{variableName}}</code>` 而不是 `<code>{{"{{variableName}}"}}</code>`

### Q2: 变量未提取到

**可能原因**：
1. JSONPath 表达式不正确
2. 前置接口执行失败
3. 响应格式与预期不符

**排查方法**：
1. 查看后端日志确认前置接口是否执行成功
2. 检查响应结构是否与 JSONPath 匹配
3. 使用在线 JSONPath 工具测试表达式

### Q3: 变量未替换

**可能原因**：
1. 变量名拼写错误
2. 占位符格式不正确（必须是 `{{variableName}}`）
3. 参数类型不支持字符串

**解决**：
1. 检查变量名是否一致
2. 确保使用双花括号：`{{variableName}}`
3. 确认参数字段是字符串类型

### Q4: 数据库错误

**症状**：
```
Unknown column 'test_data.pre_request_api_id' in 'field list'
```

**解决**：
重新执行数据库迁移脚本

## 📚 参考文档

- [前置接口功能使用指南.md](./前置接口功能使用指南.md) - 详细使用说明
- [QUICKSTART-前置接口.md](./QUICKSTART-前置接口.md) - 快速开始指南
- [migrate_add_pre_request.sql](./backend/migrate_add_pre_request.sql) - 数据库迁移脚本

## 🎉 完成

部署完成后，你就可以使用前置接口功能来自动处理登录和 token 管理了！

如有任何问题，请查看日志或参考使用指南。
