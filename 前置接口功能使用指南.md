# å‰ç½®æ¥å£åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## åŠŸèƒ½ä»‹ç»

å‰ç½®æ¥å£åŠŸèƒ½å…è®¸ä½ åœ¨æ‰§è¡Œä¸»æ¥å£ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œä¸€ä¸ªå‰ç½®æ¥å£ï¼ˆé€šå¸¸æ˜¯ç™»å½•æ¥å£ï¼‰ï¼Œä»å“åº”ä¸­æå–å˜é‡ï¼ˆå¦‚ accessTokenï¼‰ï¼Œç„¶ååœ¨ä¸»æ¥å£ä¸­ä½¿ç”¨è¿™äº›å˜é‡ã€‚

## ä½¿ç”¨åœºæ™¯

æœ€å¸¸è§çš„åœºæ™¯æ˜¯ï¼šéœ€è¦å…ˆè°ƒç”¨ç™»å½•æ¥å£è·å– tokenï¼Œç„¶åå°† token ä½œä¸º Authorization header ä¼ é€’ç»™å…¶ä»–éœ€è¦è®¤è¯çš„æ¥å£ã€‚

### ç¤ºä¾‹åœºæ™¯

1. **ç™»å½•æ¥å£**
   - URL: `http://192.168.100.186:8080/admin-api/system/auth/login`
   - Method: POST
   - Body:
     ```json
     {
       "tenantName": "é¼èŒ‚ç§‘æŠ€",
       "username": "admin",
       "password": "admin123",
       "captchaVerification": "K55Lc6ngHsm8CJ1Z+LoSvct/n3HiLykOSZ9kTTf3JbE3kjbW3ejlPZGtxAMwbXVQi9Yiv6WduLk0FjzoJn4x9g==",
       "rememberMe": true
     }
     ```
   - Response:
     ```json
     {
       "code": 0,
       "msg": "",
       "data": {
         "userId": 1,
         "accessToken": "2d2bd2b803a3425984aaa2aee2a483a2",
         "refreshToken": "4a00a90741b44cc0b5b8286bb71c043b",
         "expiresTime": 1765267632463
       }
     }
     ```

2. **ä¸šåŠ¡æ¥å£**
   - éœ€è¦åœ¨ Header ä¸­ä¼ é€’ `Authorization: Bearer {{accessToken}}`

## é…ç½®æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

é¦–å…ˆç¡®ä¿å®‰è£…äº† `jsonpath-ng` åº“ï¼š

```bash
cd apitest/platform/backend
pip install -r requirements.txt
```

### 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
cd apitest/platform/backend
mysql -u root -p apitest < migrate_add_pre_request.sql
```

æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œ SQLï¼š

```sql
ALTER TABLE test_data ADD COLUMN pre_request_api_id INTEGER;
ALTER TABLE test_data ADD COLUMN pre_request_test_data_id INTEGER;
ALTER TABLE test_data ADD COLUMN variable_extractions JSON;

ALTER TABLE test_data 
ADD CONSTRAINT fk_pre_request_api 
FOREIGN KEY (pre_request_api_id) 
REFERENCES apis(id) 
ON DELETE SET NULL;

ALTER TABLE test_data 
ADD CONSTRAINT fk_pre_request_test_data 
FOREIGN KEY (pre_request_test_data_id) 
REFERENCES test_data(id) 
ON DELETE SET NULL;

CREATE INDEX idx_test_data_pre_request_api_id ON test_data(pre_request_api_id);
CREATE INDEX idx_test_data_pre_request_test_data_id ON test_data(pre_request_test_data_id);
```

### 3. é‡å¯åç«¯æœåŠ¡

```bash
cd apitest/platform/backend
# åœæ­¢å½“å‰æœåŠ¡
# é‡æ–°å¯åŠ¨
sh start.sh
```

### 4. å‰ç«¯é…ç½®

1. **ä¸ºç™»å½•æ¥å£åˆ›å»ºæµ‹è¯•æ•°æ®**
   - é€‰æ‹©ç™»å½•æ¥å£ï¼ˆå¦‚ `/admin-api/system/auth/login`ï¼‰
   - ç‚¹å‡»"æ·»åŠ æµ‹è¯•æ•°æ®"
   - å¡«å†™ç™»å½•æ‰€éœ€çš„å‚æ•°ï¼ˆusername, password ç­‰ï¼‰
   - ä¿å­˜

2. **ä¸ºä¸šåŠ¡æ¥å£é…ç½®å‰ç½®æ¥å£**
   - é€‰æ‹©éœ€è¦è®¤è¯çš„ä¸šåŠ¡æ¥å£
   - ç‚¹å‡»"æ·»åŠ æµ‹è¯•æ•°æ®"
   - åœ¨"å‰ç½®æ¥å£é…ç½®"åŒºåŸŸï¼š
     - **å‰ç½®æ¥å£**ï¼šé€‰æ‹©ç™»å½•æ¥å£ï¼ˆå¦‚ `/admin-api/system/auth/login`ï¼‰
     - **å‰ç½®æ¥å£æµ‹è¯•æ•°æ®**ï¼šé€‰æ‹©åˆšæ‰åˆ›å»ºçš„ç™»å½•æµ‹è¯•æ•°æ®
     - **å˜é‡æå–è§„åˆ™**ï¼š
       - ç‚¹å‡»"æ·»åŠ å˜é‡æå–"
       - å˜é‡åï¼š`accessToken`
       - JSONPathï¼š`$.data.accessToken`ï¼ˆä»å“åº”çš„ data.accessToken å­—æ®µæå–å€¼ï¼‰
   - åœ¨"è¯·æ±‚å¤´"ä¸­ä½¿ç”¨å˜é‡ï¼š
     ```json
     {
       "Authorization": "Bearer {{accessToken}}"
     }
     ```
   - ä¿å­˜

## å˜é‡æå–è§„åˆ™è¯´æ˜

### JSONPath è¯­æ³•

å˜é‡æå–ä½¿ç”¨ JSONPath è¯­æ³•ä»å“åº”ä¸­æå–å€¼ã€‚å¸¸è§æ ¼å¼ï¼š

- `$.data.accessToken` - æå– response.data.accessToken
- `$.data.user.id` - æå– response.data.user.id
- `$.items[0].name` - æå–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ name å­—æ®µ
- `$.data.token` - æå– response.data.token

### å˜é‡ä½¿ç”¨

åœ¨æµ‹è¯•æ•°æ®çš„ä»»ä½•å­—ç¬¦ä¸²å­—æ®µä¸­ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ `{{variableName}}` è¯­æ³•å¼•ç”¨å˜é‡ï¼š

1. **Headers**
   ```json
   {
     "Authorization": "Bearer {{accessToken}}",
     "X-User-Id": "{{userId}}"
   }
   ```

2. **Query Params**
   ```json
   {
     "token": "{{accessToken}}",
     "user_id": "{{userId}}"
   }
   ```

3. **Body**
   ```json
   {
     "token": "{{accessToken}}",
     "refresh_token": "{{refreshToken}}"
   }
   ```

## æ‰§è¡Œæµç¨‹

1. ç‚¹å‡»"æ‰§è¡Œ"æŒ‰é’®
2. ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œå‰ç½®æ¥å£ï¼ˆç™»å½•ï¼‰
3. ä»å‰ç½®æ¥å£å“åº”ä¸­æå–å˜é‡ï¼ˆaccessTokenï¼‰
4. å°†å˜é‡æ›¿æ¢åˆ°ä¸»æ¥å£çš„å‚æ•°ä¸­
5. æ‰§è¡Œä¸»æ¥å£

## è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

åç«¯ä¼šæ‰“å°è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼š

```
ğŸ”„ æ‰§è¡Œå‰ç½®æ¥å£: POST /admin-api/system/auth/login (ä½¿ç”¨æµ‹è¯•æ•°æ®: ç™»å½•æ•°æ®)
âœ… å‰ç½®æ¥å£æ‰§è¡ŒæˆåŠŸï¼Œæå–å˜é‡: ['accessToken']
  ğŸ“Œ æå–å˜é‡ accessToken = 2d2bd2b803a3425984aaa2aee2a483a2
```

### å¸¸è§é—®é¢˜

1. **å˜é‡æœªæå–åˆ°**
   - æ£€æŸ¥ JSONPath æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥å‰ç½®æ¥å£æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
   - æ£€æŸ¥å“åº”æ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ

2. **å˜é‡æœªæ›¿æ¢**
   - æ£€æŸ¥å˜é‡åæ˜¯å¦ä¸æå–è§„åˆ™ä¸­çš„åç§°ä¸€è‡´
   - æ£€æŸ¥å ä½ç¬¦æ ¼å¼æ˜¯å¦ä¸º `{{variableName}}`ï¼ˆåŒèŠ±æ‹¬å·ï¼‰

3. **å‰ç½®æ¥å£æ‰§è¡Œå¤±è´¥**
   - æ£€æŸ¥å‰ç½®æ¥å£çš„æµ‹è¯•æ•°æ®æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç¯å¢ƒé…ç½®æ˜¯å¦æ­£ç¡®

## é«˜çº§ç”¨æ³•

### æå–å¤šä¸ªå˜é‡

å¯ä»¥é…ç½®å¤šä¸ªå˜é‡æå–è§„åˆ™ï¼š

```
accessToken -> $.data.accessToken
refreshToken -> $.data.refreshToken
userId -> $.data.userId
expiresTime -> $.data.expiresTime
```

ç„¶ååœ¨ä¸»æ¥å£ä¸­ä½¿ç”¨ï¼š

```json
{
  "headers": {
    "Authorization": "Bearer {{accessToken}}",
    "X-User-Id": "{{userId}}"
  },
  "body": {
    "user_id": "{{userId}}",
    "expires_at": "{{expiresTime}}"
  }
}
```

### åµŒå¥—è·¯å¾„æå–

å¦‚æœå“åº”ç»“æ„è¾ƒæ·±ï¼Œå¯ä»¥ä½¿ç”¨åµŒå¥—è·¯å¾„ï¼š

```json
{
  "code": 0,
  "data": {
    "user": {
      "profile": {
        "avatar": "https://example.com/avatar.jpg"
      }
    }
  }
}
```

æå–è§„åˆ™ï¼š`avatar -> $.data.user.profile.avatar`

## æ³¨æ„äº‹é¡¹

1. å‰ç½®æ¥å£ä¼šåœ¨æ¯æ¬¡æ‰§è¡Œä¸»æ¥å£æ—¶éƒ½æ‰§è¡Œä¸€æ¬¡
2. å˜é‡åªåœ¨å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æœ‰æ•ˆï¼Œä¸ä¼šæŒä¹…åŒ–
3. å¦‚æœå‰ç½®æ¥å£æ‰§è¡Œå¤±è´¥ï¼Œä¸»æ¥å£ä»ä¼šç»§ç»­æ‰§è¡Œï¼ˆä½†å˜é‡ä¸ºç©ºï¼‰
4. å˜é‡æ›¿æ¢æ”¯æŒä»»æ„æ·±åº¦çš„ JSON ç»“æ„
5. å¦‚æœæ•´ä¸ªå­—ç¬¦ä¸²å°±æ˜¯ä¸€ä¸ªå˜é‡å ä½ç¬¦ï¼ˆå¦‚ `"{{userId}}"`ï¼‰ï¼Œä¼šä¿æŒåŸå§‹ç±»å‹ï¼ˆå¦‚æ•°å­—ã€å¸ƒå°”å€¼ï¼‰
6. å¦‚æœå­—ç¬¦ä¸²ä¸­åŒ…å«å¤šä¸ªå ä½ç¬¦æˆ–å…¶ä»–å†…å®¹ï¼ˆå¦‚ `"Bearer {{token}}"`ï¼‰ï¼Œç»“æœå§‹ç»ˆæ˜¯å­—ç¬¦ä¸²

## ç¤ºä¾‹é…ç½®æ–‡ä»¶

å®Œæ•´çš„æµ‹è¯•æ•°æ®é…ç½®ç¤ºä¾‹ï¼š

```json
{
  "name": "è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦è®¤è¯ï¼‰",
  "pre_request_api_id": 1,  // ç™»å½•æ¥å£çš„ ID
  "pre_request_test_data_id": 10,  // ç™»å½•æµ‹è¯•æ•°æ®çš„ ID
  "variable_extractions": {
    "accessToken": "$.data.accessToken"
  },
  "headers": {
    "Authorization": "Bearer {{accessToken}}",
    "Content-Type": "application/json"
  },
  "query_params": {
    "page": 1,
    "size": 10
  }
}
```
